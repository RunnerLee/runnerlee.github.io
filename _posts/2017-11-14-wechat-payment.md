---
layout: post
title: 微信支付接入
category: 技术
tags: wechat payment
description: 微信支付接入
---

微信支付到目前为止总有六种支付产品:

- 公众号支付
- app 支付
- 扫码支付
- H5 支付
- 小程序支付
- 刷卡支付

其中, 除刷卡支付以外, 其他的五种支付产品是 web 中经常使用的. 这五种支付产品的使用场景不同, 对应的支付流程的前置操作及拉起支付操作都不同. 

查看文档可以看到, 无论哪一种支付产品, 都有几个相同的操作:

1. 申请预支付 ID, 根据支付产品的类型, 传入不同的参数
2. 接收微信支付通知, 不同的支付产品会返回不同的支付产品标识
3. 查询交易, 参数一致
4. 退款, 参数一致

所以通用的支付流程大概如下:
```
                     ┌ ─ ─ ─ ─ ─ ─ ─ ┐    ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─     ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
                       apply payment  ─ ─▶  call wechat charge │─ ─▶  charge notification  
                     └ ─ ─ ─ ─ ─ ─ ─ ┘    └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─     └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
```

不同的支付产品, 主要是在申请预支付交易之前有一些前置动作 (例如公众号支付需要获取 `openid`), 以及拉起支付的方式不同 (例如公众号支付只能在微信内支付, H5 支付只能在微信外浏览器拉起微信客户端进行支付.)


### H5 支付
H5 支付在微信中的 `trade_type` 是 `MWEB`, 支付流程是, 在微信外, 申请预支付交易时会返回一个 `mweb_url`, 将用户重定向到 `mweb_url` 后, 将在由微信提供的页面中, 拉起微信客户端 (如果网页是在 app 内嵌 web view 中打开, 需确保支持拉起 `weixin://` 的 scheme), 进行支付.

未完待续...

### 公众号支付

### app 支付

### 扫码支付

### 小程序支付

